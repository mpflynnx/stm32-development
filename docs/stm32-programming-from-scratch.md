## STM32 Programming From Scratch | C Programming | Assembler | GCC | Makefile

Notes made while watching [STM32 Programming From Scratch | C Programming | Assembler | GCC | Makefile](https://www.youtube.com/watch?v=gdRmETe4QEo&t) by [Martin K. Schr√∂der](https://www.youtube.com/@mkschreder)

You need to have available the reference manual for the device you want to program.

- [pdf | STM32F429 Reference manual](https://www.st.com/content/ccc/resource/technical/document/reference_manual/3d/6d/5a/66/b4/99/40/d4/DM00031020.pdf/files/DM00031020.pdf/jcr:content/translations/en.DM00031020.pdf)

Create a main.c file that contains just a main function.

```c
int main(void) {
    while(1);
    return 0;
}
```

Link program (main.c) to a binary that can run on stm32 mcu.

To create the binary file we need to find the memory map of the device from the reference manual.

Page 71/1756 Table 4. Memory mapping vs. Boot mode/physical remap in STM32F42xxx and STM32F43xxx

The code will reside in FLASH memory.

| Addresses | Boot/Remap in main Flash memory | Boot/Remap in embedded SRAM | Boot/Remap in System memory | Remap in FMC |
| ------- | ------- | ------- | ------- | ------- |
| 0x0800 0000 - 0x081F FFFF | Flash memory | Flash memory | Flash memory | Flash memory |

First word in flash is the pointer to the stack the second is the program counter


Small application can be run from RAM.

Smaller RAM memory - Core coupled memory CCMRAM

| Addresses | Boot/Remap in main Flash memory | Boot/Remap in embedded SRAM | Boot/Remap in System memory | Remap in FMC |
| ------- | ------- | ------- | ------- | ------- |
| 0x2002 0000 - 0x2002 FFFF | SRAM3 (64 KB) | SRAM3 (64 KB) | SRAM3 (64 KB) | SRAM3 (64 KB) |

Main SRAM memory - RAM for variables 
| Addresses | Boot/Remap in main Flash memory | Boot/Remap in embedded SRAM | Boot/Remap in System memory | Remap in FMC |
| ------- | ------- | ------- | ------- | ------- |
| 0x2001 C000 - 0x2001 FFFF | SRAM2 (16 KB) | SRAM2 (16 KB) | SRAM2 (16 KB)| SRAM2 (16 KB) |
| 0x2000 0000 - 0x2001 BFFF | SRAM1 (112 KB) | SRAM1 (112 KB) | SRAM1 (112 KB) | SRAM1 (112 KB)|

### Linker script

C code is compiled into object code then the linker, links any other object files to create the final binary.

The linker script tell the linker where to place all the code in memory.

The linker script is used to define the memory layout. linker.ld file
```ld
/* Entry Point */
ENTRY(Reset_Handler)
```

```ld
/* Memories definition */
MEMORY
{
  FLASH (rx)    : ORIGIN = 0x08000000,   LENGTH = 2048K
  CCMRAM(xrw)   : ORIGIN = 0x10000000,   LENGTH = 64K
  RAM(xrw)      : ORIGIN = 0x20000000,   LENGTH = 192K

}
```

Calculate location of stack pointer, place it at the end of main SRAM memory. Using _estack symbol

```ld
/* Highest address of the user mode stack */
_estack = ORIGIN(RAM) + LENGTH(RAM); /* end of "RAM" Ram type memory */

_Min_Heap_Size = 0x200; /* required amount of heap */
_Min_Stack_Size = 0x400; /* required amount of stack */
```

## External References
- [Markdown Cheatsheet](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet#tables)
- [safeshare | view video without distraction](https://safeshare.tv/x/ss663206661a1d6#)
- [LinkerScript.ld | Auto-generated by STM32CubeIDE](/docs/STM32F429ZITX_FLASH.ld)